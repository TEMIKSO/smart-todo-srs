-- Пользователи системы
CREATE TABLE Users (
    user_id INTEGER PRIMARY KEY AUTOINCREMENT,
    username TEXT NOT NULL UNIQUE,
    email TEXT NOT NULL UNIQUE,
    created_at TEXT DEFAULT (datetime('now'))
);

-- Колоды карточек
CREATE TABLE Decks (
    deck_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    user_id INTEGER NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- Карточки для запоминания
CREATE TABLE Cards (
    card_id INTEGER PRIMARY KEY AUTOINCREMENT,
    question TEXT NOT NULL,
    answer TEXT NOT NULL,
    user_id INTEGER NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (user_id) REFERENCES Users(user_id) ON DELETE CASCADE
);

-- Связь многие-ко-многим между колодами и карточками
CREATE TABLE Deck_Cards (
    deck_id INTEGER,
    card_id INTEGER,
    assigned_at TEXT DEFAULT (datetime('now')),
    PRIMARY KEY (deck_id, card_id),
    FOREIGN KEY (deck_id) REFERENCES Decks(deck_id) ON DELETE CASCADE,
    FOREIGN KEY (card_id) REFERENCES Cards(card_id) ON DELETE CASCADE
);

-- История и параметры повторений
CREATE TABLE Reviews (
    review_id INTEGER PRIMARY KEY AUTOINCREMENT,
    card_id INTEGER NOT NULL,
    ease_factor REAL NOT NULL DEFAULT 2.5, -- Фактор легкости (из алгоритма SM-2)
    interval_days INTEGER NOT NULL DEFAULT 1, -- Интервал в днях до след. повторения
    next_review_date TEXT NOT NULL, -- Дата следующего повторения
    repetitions INTEGER NOT NULL DEFAULT 0, -- Количество повторений
    reviewed_at TEXT DEFAULT (datetime('now')), -- Дата и время этого повторения
    grade INTEGER, -- Оценка пользователя (0-5)
    FOREIGN KEY (card_id) REFERENCES Cards(card_id) ON DELETE CASCADE
);

-- Индексы для оптимизации запросов
CREATE INDEX idx_cards_user_id ON Cards(user_id);
CREATE INDEX idx_reviews_card_id ON Reviews(card_id);
CREATE INDEX idx_reviews_next_review_date ON Reviews(next_review_date);
CREATE INDEX idx_decks_user_id ON Decks(user_id);
CREATE INDEX idx_deck_cards_deck_id ON Deck_Cards(deck_id);
CREATE INDEX idx_deck_cards_card_id ON Deck_Cards(card_id);